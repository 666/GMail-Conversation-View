<!DOCTYPE html>

<html>

<head>
  <title>Conversation Reader</title>
  <link rel="stylesheet" type="text/css" href="chrome://messenger/skin/tagColors.css"/>
  <link rel="stylesheet" type="text/css" href="chrome://conversations/skin/conversation.css">
  <script type="text/javascript" src="chrome://conversations/content/js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="chrome://conversations/content/js/jquery.text-overflow.js"></script>
  <script type="application/javascript;version=1.8">
    function scrollNodeIntoView (aNode) {
      let offset = aNode.offsetTop || 0;
      let parent = aNode.parentNode;
      while (parent && !(parent instanceof HTMLDocument)) {
        let style = window.getComputedStyle(parent, null);
        if (style.position == "relative")
          offset += parent.offsetTop;
        parent = parent.parentNode;
      }
      // The header is 44px high (yes, this is harcodeadly ugly).
      window.scrollTo(0, offset + 5 - 44);
    }

    function toggleQuote(event, showquotedtext, hidequotedtext) {
      let link = event.target;
      let div = link.nextSibling;
      let cs = window.getComputedStyle(div, null);
      if (div.style.display == "none") {
        link.textContent = "- "+hidequotedtext+" -";
        div.style.display = "";
        let h = div.getBoundingClientRect().height +
          parseFloat(cs.marginTop) + parseFloat(cs.marginBottom);
        return h;
      } else {
        let h = div.getBoundingClientRect().height;
        h += parseFloat(cs.marginTop);
        h += parseFloat(cs.marginBottom);
        link.textContent = "- "+showquotedtext+" -";
        div.style.display = "none";
        return -h;
      }
    }

    const kPopupTimeout = 500;

    function enableTooltips(aMsg) {
      let $aMsgNode = $(aMsg._domNode);
      $aMsgNode.find('.tooltip').each(function (i) {
        // "details" is a hypothetical "details" link that, when
        //   hovered/clicked, starts the interaction with the tooltip
        let $tooltip = $(this);
        let $details = $tooltip.prev();

        let sticky = false;
        let timeout;
        /* $details.get(0).addEventListener("click", function (event) {
          sticky = !sticky;
          event.stopPropagation();
        }, false); */
        $details.hover(
          function() {
            if (aMsg.collapsed)
              return;
            if (!sticky) {
              clearTimeout(timeout);
              let self = this;
              timeout = setTimeout(function () {
                $(self).next(':hidden').fadeIn();
              }, kPopupTimeout);
            }
          },
          function() {
            var self = this;
            if (!sticky) {
              clearTimeout(timeout);
              timeout = setTimeout(function () {
                $(self).next(/*':visible'*/).fadeOut()
              }, kPopupTimeout);
            }
          });
        $tooltip.hover(
          function () {
            clearTimeout(timeout);
          },
          function () {
            var self = this;
            if ($(this).is(":visible") && !sticky) {
              clearTimeout(timeout);
              timeout = setTimeout(function () {
                $(self).fadeOut();
              }, kPopupTimeout);
            }
          });
      });
    }

    let Conversations = window.top.Conversations;
    Components.utils.import("resource://conversations/MsgHdrUtils.jsm");
    Components.utils.import("resource://conversations/log.js");

    let Log = setupLogging("Conversations.Stub");

    // Mark the current conversation as read/unread. The conversation driver
    //  takes care of setting the right class on us whenever the state
    //  changes...
    function toggleRead(event) {
      let $span = $(event.target).find("span.read");
      if ($span.hasClass("unread")) {
        Conversations.currentConversation.read = true;
        $span.removeClass("unread");
      } else {
        Conversations.currentConversation.read = false;
        $span.addClass("unread");
      }
    }

    function expandCollapse(event) {
      let $span = $(event.target).find("span.expand");
      if ($span.hasClass("collapse")) {
        [message.collapse()
          for each ([, { message }] in Iterator(Conversations.currentConversation.messages))];
        $span.removeClass("collapse");
      } else {
        [message.expand()
          for each ([, { message }] in Iterator(Conversations.currentConversation.messages))];
        $span.addClass("collapse");
      }
    }

    function archiveConversation(event) {
      msgHdrsArchive(Conversations.currentConversation.msgHdrs);
    }

    function deleteConversation(event) {
      msgHdrsDelete(Conversations.currentConversation.msgHdrs);
    }

    // Setting the second parameter to false means don't fire a stupid timer
    //  that lives forever everytime we call this function.
    function fakeTextOverflowSubject() {
      $(".subject").textOverflow(null, false);
    }

    function fakeTextOverflowParticipants(aMsgNode) {
      $(aMsgNode).find(".to").textOverflow(null, false);
    }

    document.addEventListener("focus", function (event) {
      /* This is a persistent event listener. It can operate multiple
       * times. We have the invariant that for a given conversation, there's at
       * most one such element (recycling doesn't use tabindex 1). */
      let msgNode = document.querySelector(".message[tabindex=\"1\"]");
      if (!msgNode)
        return;

      /* Restore the proper tab order. This event is fired *after* the
       * right message has been focused in Gecko 1.9.2, *before* the right
       * message has been focused in Gecko 1.9.1 (so it's basically
       * useless). */
      let msgNodes = document.getElementsByClassName("message");
      let index;
      for each (let [i, k] in Iterator(msgNodes)) {
        if (k == msgNode) {
          index = i;
          break;
        }
      }
      if (!index)
        Log.error("Couldn't find the given msgNode???");
      else
        msgNode.setAttribute("tabindex", index+2);
    }, true);
  </script>
</head>

<body>
  <div id="wrapper">
    <div id="conversationHeaderWrapper">
      <div id="conversationHeader" class="hbox">
        <div class="subject boxFlex">This is an example of a subject</div>
        <div class="actions">
          <button onclick="deleteConversation(event);"><img src="i/trash.png" /></button>
          <button onclick="archiveConversation(event);"><img src="i/archive.png" /></button>
          <button onclick="expandCollapse(event);"><span class="expand"></span></button>
          <button onclick="toggleRead(event);"><span class="read"></span></button>
          <button><img src="i/tab.png" /></button>
          <!--<button><span class="mode"></span></button>-->
        </div>
      </div>
    </div>
    <ul id="messageList">
    </ul>
  </div>
</body>
</html>
